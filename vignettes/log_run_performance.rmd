---
title: "temp"
subtitle: 'Preliminary draft'
author: "Michael Gurkov"
date: "`r format(Sys.time(), '%B %d, %Y')`"
fontsize: 11pt
output:
  rmarkdown::pdf_document:
    number_sections: true
abstract: "Text for abstract"
bibliography: ipo_long_run.bib
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,echo = FALSE,
  message = FALSE,warning = FALSE,
  comment = "#>"
)
```


<!-- import_data -->


```{r load_libraries}

library(tidyverse)

library(xts)

library(lubridate)

library(stargazer)

devtools::load_all()

# library(MiscImport)

```


```{r import_ta_125}

ta_125 = read_csv(paste0(Sys.getenv("USERPROFILE"),
                         "\\OneDrive - Bank Of Israel\\Data",
                         "\\TASE liquidity\\michael files",
                         "\\TA125.csv"),
                  show_col_types = FALSE) %>% 
  mutate(date = dmy(date))

```

```{r import_tase_sector}

tase_sector_df = read_csv(paste0(Sys.getenv("USERPROFILE"),
                                 "\\OneDrive - Bank Of Israel\\Data",
                                 "\\TASE liquidity\\michael files",
                                 "\\tase_sector_and_sub_sector_classification.csv"),
                          show_col_types = FALSE) %>% 
  select(-comp_name_heb) %>% 
  filter(!tase_sector == "#N/A") %>% 
  mutate(date = as.yearmon(date, format = "%m/%d/%Y")) %>% 
  mutate(across(-date, as.character)) %>% 
  select(-tase_sub_sector)

```

```{r import_market_df, cache=TRUE}

market_df_filepath = paste0(Sys.getenv("USERPROFILE"),
                                "\\OneDrive - Bank Of Israel\\Data",
                                "\\TASE liquidity\\Rdata files",
                                "\\market_data_2023-01-01.rds")

market_df = import_boi_market_data(market_df_filepath) %>% 
  calculate_adjusted_price() %>% 
  filter(date <= max(ta_125$date))

rm(market_df_filepath)

```

```{r import_ipo_list}

stocks_ipo = read_csv(paste0(Sys.getenv("USERPROFILE"),
                             "\\OneDrive - Bank Of Israel",
                             "\\Data\\TASE liquidity",
                             "\\michael files\\stocks_ipo.csv"),
                      show_col_types = FALSE) %>% 
  mutate(tase_id = as.character(tase_id))

stocks_ipo = stocks_ipo %>% 
  mutate(tase_id = recode(tase_id,
                          `456` = "259"))

cpi_df = read_csv(paste0(Sys.getenv("USERPROFILE"),
                         "\\OneDrive - Bank Of Israel\\Data",
                         "\\BoI\\monetary_data\\cpi.csv"),
                  show_col_types = FALSE,
                  skip = 15,col_names = c("date","cpi")) %>% 
  mutate(date = dmy(date)) %>% 
  group_by(year = year(date)) %>% 
  summarise(cpi = mean(cpi), .groups = "drop") %>% 
  filter(year >= 2000) %>% 
  mutate(cpi = cpi / cpi[year == 2000])


stocks_ipo = stocks_ipo %>% 
  left_join(cpi_df, by = "year") %>% 
  mutate(real_domestic_issue = domestic_issue / cpi) %>% 
  select(-cpi)

rm(cpi_df)

# ipo_trade_dur_df = market_df %>% 
#   group_by(tase_id, sec_id) %>% 
#   summarise(tibble(first_trade_year = year(min(date)),
#                    trade_years = (max(date) - min(date)) %/% dyears(1)),
#             .groups = "drop")
# 
# stocks_ipo = stocks_ipo %>% 
#   left_join(ipo_trade_dur_df, by = "tase_id") %>% 
#   arrange(tase_id) %>% 
#   filter(!is.na(trade_years))
# 
# 
# 
# num_ipo = stocks_ipo %>% 
#   count(tase_id, sort = TRUE)
# 
# 
# stocks_ipo = stocks_ipo %>% 
#   inner_join(num_ipo %>% 
#                filter(n == 1) %>% 
#                select(tase_id), by = "tase_id")
# 
# rm(ipo_trade_dur_df)

```


```{r price_df}

price_df = market_df %>% 
  select(date, sec_id, tase_id, price = close_adjusted) %>% 
  inner_join(stocks_ipo %>% 
               select(tase_id) %>% 
               distinct())

price_df = price_df %>% 
  left_join(ta_125 %>% 
              rename(index = ta_125), by = "date")

price_df = price_df %>% 
  unite(col = "id", c("tase_id", "sec_id")) %>% 
  group_by(id) %>%
  mutate(month = as.numeric(date - date[date == min(date)]) %/% 21) %>%
  group_by(id, month) %>%
  summarise(across(c("price","index"), ~mean(., na.rm = TRUE)),
            .groups = "drop")


```

```{r returns}

ret_df = price_df %>%
    group_by(id) %>%
    arrange(month) %>%
    mutate(across(c("price","index"),
                  ~ . /lag(.) - 1,
                  .names = "{.col}_ret")) %>%
    ungroup() %>%
    select(-c("price","index")) %>% 
  filter(complete.cases(.))

```


```{r cumulative_returns}

weights = ret_df %>% 
  select(id) %>% 
  distinct() %>% 
  mutate(tase_id = str_extract(id, "[0-9]{4}")) %>% 
  left_join(stocks_ipo %>%
              select(tase_id, real_domestic_issue) %>% 
              distinct(), by = "tase_id") %>% 
  group_by(id) %>%
  summarise(issue = mean(real_domestic_issue, na.rm = TRUE),
            .groups = "drop") %>% 
  filter(complete.cases(.))


cum_ret = ret_df %>% 
  select(id, month, close_ret, index_ret) %>% 
  filter(complete.cases(.)) %>% 
  mutate(abnormal_ret = close_ret - index_ret) %>% 
  select(id, month, abnormal_ret) %>% 
  left_join(weights)


cum_ret %>% 
  filter(month<=60) %>% 
  filter(complete.cases(.)) %>% 
  group_by(month) %>% 
  summarise(median = median(abnormal_ret),
            mean = mean(abnormal_ret),
            weighted_mean = weighted.mean(x = abnormal_ret, w = issue),
            .groups = "drop") %>% 
  arrange(month) %>% 
  mutate(across(-month, cumsum)) %>% 
  mutate(month = month + 1) %>% 
  pivot_longer(-month) %>% 
  ggplot(aes(month, value, color = name)) + 
  geom_line()

cum_ret %>% 
  filter(month<=60) %>% 
  filter(complete.cases(.)) %>% 
  group_by(month) %>% 
  summarise(median = median(abnormal_ret),
            mean = mean(abnormal_ret),
            weighted_mean = weighted.mean(x = abnormal_ret, w = issue),
            .groups = "drop") %>% 
  arrange(month) %>% 
  mutate(across(-month, cumsum)) %>% 
  mutate(month = month + 1) %>%
  write_csv(paste0("C:\\Users\\Home",
                   "\\OneDrive - Bank Of Israel\\current_work",
                   "\\annual_report\\2022\\data\\plots\\",
                   "cum_ret_plot.csv"))


```

