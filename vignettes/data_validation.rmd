
<!-- Import data and libraries -->


```{r , child="import_data.Rmd}

```



```{r holding_returns_by_year}

bhar_year_ret = stocks_ipo %>% 
  select(tase_id, indicator = year) %>% 
  calculate_holding_return_by_indicator(ret_df = ret_df,
                                                      ind_df = .)

```




<!-- 1465_1105139 -->

```{r compare_prices_with_index}


temp_price_1465 = market_df %>% 
  filter(tase_id == 1465) %>% 
  select(date,close_adjusted) %>% 
  left_join(ta_125, by = "date") %>% 
  rename(close = close_adjusted, index = ta_125) %>% 
  mutate(month = as.numeric(date - min(date)) %/% 22 + 1) %>% 
  group_by(month) %>% 
  summarise(across(c("close", "index"), ~mean(., na.rm = TRUE)),
            .groups = "drop")


all.equal(temp_price_1465, price_df %>%
  filter(id == "1465_1105139") %>% 
  select(month, close, index))

temp_price_1465 %>% 
  mutate(across(c("close", "index"), ~./.[month == min(month)])) %>% 
  pivot_longer(-month) %>% 
  ggplot(aes(month, value, color = name)) + 
  geom_line()


```


```{r calculate_returns}

temp_ret_1465 = temp_price_1465  %>% 
  mutate(across(c("close", "index"), ~. / lag(.) - 1,
                .names = "{.col}_ret")) %>% 
  filter(complete.cases(.)) %>% 
  select(month, close_ret, index_ret) %>% 
  mutate(index_ret = close_ret - index_ret)

all.equal(temp_ret_1465, ret_df %>%
            filter(id == "1465_1105139") %>% 
            select(month,close_ret,index_ret) %>% 
            mutate(index_ret = close_ret - index_ret))


temp_ret_1465 %>% 
  mutate(across(-month, cumsum)) %>% 
  pivot_longer(-month) %>% 
  ggplot(aes(month, value, color = name)) + 
  geom_line()

```


<!-- 1140_1087022 -->


```{r}

price_df %>% 
  filter(id == "1140_1087022") %>% 
  ggplot(aes(month, close)) + 
  geom_line()

```


```{r calculate_car}

temp_ret = price_df %>% 
  select(-control) %>% 
  filter(id == "1140_1087022") %>% 
  arrange(month) %>% 
  mutate(across(c("close","index"),
                ~./lag(.) - 1, .names = "{.col}_ret")) %>% 
  filter(complete.cases(.)) %>% 
  select(-c("close","index"))

all.equal(temp_ret,ret_df %>% 
  filter(id == "1140_1087022") %>% 
  select(-control_ret))
  

```

```{r calculate_bhar}

temp_bhar = temp_ret %>% 
  mutate(across(ends_with("ret"), ~cumprod(1 + .)) - 1) %>% 
  filter(month == 36) %>% 
  mutate(index_ret = close_ret - index_ret) %>% 
  select(ends_with("ret")) %>% 
  pivot_longer(everything(), names_to = "adjustment_type") %>% 
  mutate(adjustment_type = factor(adjustment_type,
                                  levels = c("close_ret",
                                             "index_ret"),
                                  labels = c("Raw returns",
                                             "Index adjusted returns")))

all.equal(temp_bhar,bhar_year_ret %>% 
            filter(indicator == 2002) %>% 
            select("adjustment_type","value") %>% 
            mutate(adjustment_type = droplevels(adjustment_type)))

```


```{r choose_ipo_control}

temp_ipo_tase_id = "1794"

temp_control_tase_id = "1668"


```


```{r temp_price_df}

temp_price_df = market_df %>% 
  select(tase_id, date, close_adjusted) %>% 
  filter(tase_id %in% c(temp_ipo_tase_id, temp_control_tase_id)) %>% 
  mutate(tase_id = recode(tase_id,
                          !!sym(temp_control_tase_id) := "control",
                          !!sym(temp_ipo_tase_id) := "close")) %>% 
  pivot_wider(names_from = tase_id, values_from = close_adjusted) %>% 
  filter(!is.na(close)) %>% 
  left_join(ta_125, by = "date") %>% 
  rename(index = ta_125) %>% 
  select(date, close, index, control)


all.equal(temp_price_df, price_df %>% 
            filter(id == "1794_1162775") %>% 
            select(date, close, index, control))
  



```


```{r temp_ret_df}


temp_ret_df = temp_price_df %>% 
  mutate(month = as.numeric(date - date[date == min(date)]) %/% 22 + 1) %>% 
  group_by(month) %>% 
  summarise(across(-date,~mean(., na.rm = TRUE)),
            .groups = "drop_last") %>% 
  arrange(month) %>% 
  mutate(across(-month,~ . /lag(.) - 1,
                .names = "{.col}_ret")) %>% 
  select(month, contains("ret"))


all.equal(temp_ret_df,ret_df  %>% 
            filter(id == "1794_1162775") %>% 
            select(-id))


```


```{r temp_adjusted_ret}

temp_adj_ret_df = temp_ret_df %>% 
  pivot_longer(-c(month, close_ret),
               names_to = "benchmark",
               values_to = "benchmark_ret") %>% 
  filter(complete.cases(.)) %>% 
  mutate(adjusted_ret = close_ret - benchmark_ret) %>% 
  select(-benchmark_ret) %>% 
  pivot_wider(names_from = "benchmark",
              values_from = "adjusted_ret") %>% 
  pivot_longer(-month,names_to = "adjustment_type")

all.equal(temp_adj_ret_df, adj_ret_df %>% 
            filter(id == "1794_1162775") %>% 
            select(-id))


```


```{r temp_cum_ret}

temp_cum_ret = temp_adj_ret_df %>% 
  filter(month <= 120) %>% 
  group_by(adjustment_type) %>% 
  arrange(month) %>% 
  mutate(value = cumsum(value)) %>% 
  ungroup()


```


```{r plot_returns}

temp_cum_ret %>% 
  pivot_longer(-month) %>% 
  ggplot(aes(month, value, color = name)) + 
  geom_line()


ret_df %>% 
  filter(id == "1794_1162775") %>% 
  ggplot(aes(month, value, color = adjustment_type)) + 
  geom_line()

```


