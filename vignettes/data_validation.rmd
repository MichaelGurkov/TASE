```{r}

library(MiscImport)

library(tidyverse)

```



# Outliers

## Mirland (tase_id == 1108) 

```{r plot_prices}

clean_market_df %>% 
  filter(tase_id == 1108) %>% 
  filter(date == min(date))

```

## Canada Global (tase id == 106)

```{r}

canada_price_data = read_csv("C:\\Users\\internet\\Desktop\\temp_canada.csv",
                             show_col_types = FALSE) %>% 
  mutate(date = dmy(date)) %>% 
  arrange(date)

canada_price_data %>% 
  pivot_longer(-date) %>% 
  ggplot(aes(date, value, color = name)) + 
  geom_line()


clean_market_df %>% 
  filter(tase_id == 106) %>% 
  ggplot(aes(date, price)) + 
  geom_line()
  
```


# Bhar market_daily

```{r}

clean_market_df %>% 
  filter(tase_id == 1108) %>% 
  mutate(price = price / price[date == min(date)]) %>% 
  ggplot(aes(date, price)) + 
  geom_line() + 
  xlab(NULL) + ylab(NULL)
           

ta125_match %>% 
  filter(id == 1108) %>% 
  select(date, contains("price")) %>% 
  pivot_longer(-date) %>% 
  group_by(name) %>% 
  mutate(value = value / value[date == min(date)]) %>% 
  ungroup() %>% 
  ggplot(aes(date, value, color = name)) + 
  geom_line() + 
  xlab(NULL) + ylab(NULL)

```










# Matching by size

The ipo company is "1062_1098755", Gilz company that issued stocks in 
2006. The price  trajectory of the stock is

```{r lodan_price}

market_df %>% 
  filter(tase_id == "1062") %>% 
  filter(date <= "2009-05-11") %>% 
  ggplot(aes(date, close_adjusted)) + 
  geom_line() + 
  facet_wrap(~sec_id, scales = "free")

```

On the first day of trading the market value of the company was 68.5 millions
The matching company is "2119_1082817" with market cap of 68.6 millions

The price trajectories of both companies are

```{r price_trajectory}

price_df %>% 
  filter(id == "1062_1098755") %>% 
  select(date, contains("price")) %>% 
  rename(`1062_1098755` = price_ipo) %>% 
  rename(`2119_1082817` = price_control) %>% 
  pivot_longer(-date) %>% 
  ggplot(aes(date, value)) + 
  geom_line() + 
  facet_wrap(~name, scales = "free")


```

In order to calculate the buy and hold return we take the first and last price

```{r}

temp_bhar = price_df %>% 
  filter(id == "1062_1098755") %>% 
  mutate(duration = as.numeric(date - min(date))) %>% 
  filter(duration <= 251 * 3) %>% 
  arrange(duration) %>% 
  select(date, duration, contains("price")) %>% 
  slice(1, length(duration)) %>% 
  summarise(bhar_ipo = price_ipo[2] / price_ipo[1] - 1,
            bhar_control = price_control[2] / price_control[1] - 1,
            bhar_abnormal = bhar_ipo - bhar_control,
            duration = duration[2], .groups = "drop")

all.equal(temp_bhar,bhar_3 %>% 
            filter(id == "1062_1098755") %>% 
            select(-contains("id")))

```

