
```{r load_libraries}

library(tidyverse)

library(zoo)

library(lubridate)

```


```{r Import_tase_comps_list}

del_comps_filepath = paste0("C:\\Users\\internet",
                            "\\OneDrive - Bank Of Israel",
                            "\\Data\\TASE liquidity",
                            "\\michael files\\delisted_comps.csv")

ipo_filepath = paste0("C:\\Users\\internet",
                            "\\OneDrive - Bank Of Israel",
                            "\\Data\\TASE liquidity",
                            "\\michael files\\ipo_dates.csv")

comps_dates = import_comps_dates_and_status(ipo_filepath,
                                            del_comps_filepath) %>% 
  filter(!tase_id %in% c("1286","1701"))

rm(del_comps_filepath, ipo_filepath)

```


```{r match_delisted_and_control_by_size}

df = read_rds(paste0("C:\\Users\\internet",
                     "\\OneDrive - Bank Of Israel\\Data",
                     "\\TASE liquidity\\Rdata files",
                     "\\final_df_2022-11-20.rds"))

match_by_size = comps_dates %>% 
  mutate(delisted_status = if_else(is.na(quotation_period),0,1)) %>% 
  select(tase_id, ipo_date, delisted_status) %>% 
  match_control_group(data_df = df,
                      matching_variable = "size",
                      threshold = 0.15)


```

```{r save_matching_df}

matching_table_by_size %>% 
  write_csv(paste0("C:\\Users\\internet",
                   "\\OneDrive - Bank Of Israel",
                   "\\Data\\TASE liquidity",
                   "\\michael files\\matching_table_by_size.csv"))


```

```{r summary_control_vs_delisted}


matched_comps_summary = match_by_size %>% 
  left_join(comps_dates %>% 
              select(tase_id, contains("date")),
            by = c("tase_id_delisted" = "tase_id")) %>% 
  pivot_to_join_format() %>% 
  left_join(df, by = c("tase_id",c("time_period" = "date")))

matched_comps_summary = matched_comps_summary %>% 
  select(-time_period) %>% 
  group_by(tase_id, comp_type) %>% 
  summarise(across(everything(), ~mean(., na.rm = TRUE)),
            .groups = "drop") %>% 
  select(-tase_id) %>% 
  group_by(comp_type) %>% 
  summarise(across(everything(), ~round(median(., na.rm = TRUE),2)),
            .groups = "drop") %>% 
  pivot_longer(-comp_type) %>% 
  pivot_wider(names_from = comp_type)

```

