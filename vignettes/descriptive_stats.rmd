
```{r text_params}

num_ipo = nrow(stocks_ipo)

num_ipo_waves =  stocks_ipo %>% 
  count(year,name = "num_ipo") %>% 
  filter(year %in% c(2000,2005:2007,2020:2022)) %>% 
  summarise(total = sum(num_ipo)) %>% 
  pull(total)

ipo_waves_share = round((num_ipo_waves / num_ipo) * 100,2)

data_period = paste(range(stocks_ipo$year), collapse = "-")

```


```{r label_params}

ipo_by_sector_lab = "IPOs by year and sector\\label{ipo_sector}"

```


The sample consists of `r num_ipo` Initial Public Offerings issued to the public during `r data_period` period on TASE. The data includes the date of the issue (month and year), the issue size and the sector of the issuing company. Table \ref{ipo_num} presents the distribution of the IPO by year in terms of the number of offers and issue size (deflated by CPI). The data shows that the IPO's come in "waves" namely that the distribution of IPOs is clustered around certain years. In my sample 2000, 2005-2007 and 2020-2022 can be characterized as "buoyant" years with high IPO activity, these periods encompass `r num_ipo_waves` out of `r num_ipo` (`r paste0(ipo_waves_share,"%")`). Table \ref{ipo_by_sector} shows the distribution of the IPOs by sector. The dominant sectors are: commerce, industry, real estate and tech. Figure \ref{ipo_sector} shows that 2000 period consisits mainly of industry and commerce, 2005-2007 period is characterized by real estate and industry and 2020-2022 period is preoccupied with tech sector.




```{r ipo_by_year, results='asis'}

stocks_ipo %>%
  select(year, domestic_issue_real) %>%
  group_by(year) %>%
  summarise(num_ipo = length(domestic_issue_real),
            real_total_issue = sum(domestic_issue_real),
            .groups = "drop") %>%
  mutate(real_total_issue = round(real_total_issue,2)) %>%
  rename(Year = year, `Number of IPO's` = num_ipo,
         `Real proceeds` = real_total_issue) %>%
  as_data_frame() %>%
  stargazer(summary = FALSE,header = FALSE, rownames = FALSE,
            title = "Distribution of IPO's by year",
            label = "ipo_num")

```


```{r ipo_by_sector, results='asis'}

stocks_ipo %>%
  select(tase_sector, domestic_issue_real) %>%
  group_by(tase_sector) %>%
  summarise(num_ipo = length(domestic_issue_real),
            real_total_issue = sum(domestic_issue_real),
            .groups = "drop") %>%
  mutate(real_total_issue = round(real_total_issue,2)) %>%
  rename(Sector = tase_sector, `Number of IPO's` = num_ipo,
         `Real proceeds` = real_total_issue) %>%
  as_data_frame() %>%
  stargazer(summary = FALSE,header = FALSE, rownames = FALSE,
            title = "Distribution of IPO's by sector",
            label = "ipo_by_sector")

```


```{r plot_ipo_by_sector, fig.cap=ipo_by_sector_lab}

stocks_ipo %>%
  count(year, tase_sector) %>%
  ggplot(aes(year,n ,fill = tase_sector)) +
  geom_col() +
  scale_fill_viridis_d() +
  xlab(NULL) + ylab(NULL) + ggtitle("IPO's by year and sector") +
  theme(legend.title = element_blank())

```



```{r table_market_and_book_to_market, results='asis'}

stocks_ipo %>% 
  select(book_to_market, market_value_real) %>% 
  filter(complete.cases(.)) %>% 
  as.data.frame() %>% 
  stargazer(header = FALSE) 

```


```{r plot_ipo_market_share}

mcap_by_years = market_df %>%
  filter(!is.na(market_value)) %>%
  mutate(market_value = market_value * 10 ^ -6) %>%
  group_by(date = year(date), sec_id) %>%
  summarise(market_value = mean(market_value, na.rm = TRUE),
            .groups = "drop_last") %>%
  summarise(market_value = sum(market_value), .groups = "drop") %>%
  filter(complete.cases(.))

stocks_ipo %>%
  select(year, market_value) %>%
  group_by(date = year) %>%
  summarise(market_value = sum(market_value, na.rm = TRUE), .groups = "drop") %>%
  left_join(mcap_by_years, by = "date",
            suffix = c("_ipo","_market")) %>%
  mutate(share = market_value_ipo / market_value_market) %>%
  filter(complete.cases(.)) %>% 
  ggplot(aes(date, share)) +
  geom_line() +
  geom_point() +
  scale_y_continuous(labels = scales::percent_format()) +
  xlab(NULL) + ylab(NULL) +
  ggtitle("Ratio of IPO market capitalization to total market cap")


```

```{r plot_size_quantiles}

market_quantiles = finrep_df %>% 
  inner_join(stocks_ipo %>% 
               select(date_yearqtr = date) %>% 
               distinct(), by = "date_yearqtr") %>% 
  left_join(stocks_ipo %>% 
              select(date_yearqtr = date, tase_id) %>% 
              distinct() %>% 
              mutate(ipo = 1), by = c("tase_id","date_yearqtr"))

market_quantiles = market_quantiles %>% 
  group_by(date_yearqtr) %>% 
  mutate(market_value = ecdf(market_value)(market_value[ipo == 1]),
         book_to_market = ecdf(book_to_market)(book_to_market[ipo == 1])) %>% 
  ungroup() %>% 
  select(tase_id, market_value, book_to_market) %>% 
  filter(complete.cases(.))

market_quantiles %>% 
  pivot_longer(-tase_id) %>% 
  ggplot(aes(value)) + 
  geom_histogram() + 
  facet_wrap(~name, scales = "free") + 
  scale_x_continuous(labels = scales::percent_format()) + 
  xlab("Quantile") + ylab(NULL) + ggtitle("IPOs distribution")

rm(market_quantiles)  

```

<!-- Attrition -->




<!-- Data checks -->

```{r plot_market_share_of_ipo_by_vintage, eval=FALSE}

temp = market_df %>%
  filter(!is.na(market_value)) %>%
  select(date, tase_id, sec_id,market_value) %>%
  group_by(date) %>%
  mutate(market_share = market_value / sum(market_value)) %>%
  left_join(stocks_ipo %>%
              select(tase_id, year) %>%
              distinct(), by = "tase_id") %>%
  group_by(date, year) %>%
  summarise(market_share = sum(market_share), .groups = "drop")

temp %>%
  filter(!is.na(year)) %>%
  filter(year %in% c(2000:2004, 2010, 2015)) %>%
  ggplot(aes(date, market_share, color = as.character(year))) +
  geom_line(linewidth = 0.7)



```


```{r market_value_completness_market_df, eval=FALSE}

market_df %>%
  group_by(year = year(date)) %>%
  summarise(market_val_data = 1- sum(is.na(market_value)) /
              length(market_value),
            .groups = "drop") %>%
  ggplot(aes(as.character(year), market_val_data)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent_format()) +
  xlab(NULL) + ylab(NULL) + ggtitle("Market value availability in market df")




```


```{r market_value_completness_finrep_df, eval=FALSE}

finrep_df %>%
  group_by(year = year(date_yearqtr)) %>%
  summarise(market_val_data = 1- sum(is.na(market_value)) /
              length(market_value),
            .groups = "drop") %>%
  ggplot(aes(as.character(year), market_val_data)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent_format()) +
  xlab(NULL) + ylab(NULL) + ggtitle("Market value availability in finrep df")




```

