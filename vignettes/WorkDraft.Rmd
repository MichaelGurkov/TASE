---
title: "Work outline"
output: pdf_document
---

```{r setup, include=FALSE,}

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

```


```{r Load_libraries}

library(devtools)

library(tidyverse)

library(xts)

library(stargazer)

load_all()

```


```{r Set_parameters}

x_vars = c("Illiq","Market_Cap_log","Turnover_log","Public_Share","HHI","IPO",
           "Total_Assets","Operating_Profit","Revenue","Net_Profit","Equity",
           "Total_Liabilities","Leverage")

```


```{r Import_market_data}

if(file.exists(paste0("C:\\Users\\internet\\Documents\\Data\\TASE\\",
                      "TASE_Liquidity\\market_df.RDS"))){
  
  market_df = read_rds(paste0("C:\\Users\\internet\\Documents\\Data\\TASE\\",
                      "TASE_Liquidity\\market_df.RDS"))
  

} else {
  
  market_df = read_rds(paste0("C:\\Users\\internet\\Documents\\Data\\TASE\\Market Data",
                          "\\Market_data_stocks_2001-2019.Rds")) %>% 
    get.market.variables()
  
}


```


```{r Import_finrep_data}

if(file.exists(paste0("C:\\Users\\internet\\Documents\\Data\\TASE\\",
                            "TASE_Liquidity\\finrep_df.RDS"))){
  
  finrep_df = read_rds(paste0("C:\\Users\\internet\\Documents\\Data\\TASE\\",
                            "TASE_Liquidity\\finrep_df.RDS"))
  
} else {
  
  finrep_df = import.boi.finrep.data() %>% 
  mutate_if(((!names(.) %in% c("Date","TASE_branch","TASE_ID")) & !is.numeric(.)),
            as.numeric) %>% 
  select(Date, TASE_ID, TASE_branch, Operating_Profit,Net_Profit,
         Equity,Revenue,Total_Assets, Total_Liabilities, Capex_CashFlow,
         Operating_CashFlow) %>% 
  mutate(Capex_to_sales = Capex_CashFlow / Revenue) %>% 
  mutate(ROA = Operating_Profit / Total_Assets) %>% 
  mutate(Free_CashFlow = Operating_CashFlow / Total_Assets)
  
  
}

```


```{r process_data}

df = full_join(finrep_df, market_df, by = c("Date" = "Date",
                                            "TASE_ID" = "Comp_ID"))

df = df %>% 
  mutate(MB = Market_Cap / Equity) %>% 
  mutate(Market_Cap_log = log(Market_Cap)) %>% 
  mutate(Turnover_log = log(Turnover)) %>% 
  mutate(Leverage = Total_Liabilities / Total_Assets)


rm(finrep_df, market_df)

```


```{r import_old_data}

old_df = import.old.regression.data()

merged_df = full_join(df,old_df[,names(old_df)[names(old_df) %in% names(df)]],
                      by = c("Date","TASE_ID"), suffix = c("_new","_old")) 

final_df = merged_df

for(varname in grep("_new$",names(final_df),value = TRUE)){
  
  main_var = sym(varname)
  
  backup_var = sym(str_replace(varname,"new","old"))
  
  final_df = final_df %>% 
    mutate(!!varname := coalesce(!!main_var,!!backup_var))
  
  rm(main_var, backup_var)

}

final_df = final_df %>% 
  select(-ends_with("_old")) %>% 
  rename_at(.vars = vars(ends_with("_new")),.funs = list(~str_remove(.,"_new")))
  

# Test for data completness

if(length(x_vars[!x_vars %in% names(final_df)]) > 0){
  
  message(paste("The following variables are missing:", paste0(x_vars[!x_vars %in% names(df)],
                                                               collapse = ",")))
  
}


```


\section{Introduction}

The purpose of the work is to identify the reasons
of firm's delistings from trade. The method is a logit regression that evaluates firm's characteristics in a sample
that consists of delisted firms and matched trading firms.

\section{Empirical specification}

\begin{align*}
	Pr(Delisting)  = \alpha & + \beta_{1} Leverage + \beta_{2} MB  
	                          + \beta_{3} CAPEX  + \beta_{4}ROA\\ 
	                        & + \beta{5} FreeCashFlow 
	                          + \beta_{6} InsiderOwnership \\
                          & + \beta_{7} Size + \beta_{8} TradeVolume 
                            + \beta_{9} Illiqudity
\end{align*}

Where:


\section{Descriptive Stats}

```{r df_stat,results='asis'}

stargazer(df, header = FALSE, omit.summary.stat = c("p25","p75","sd"))

```



```{r final_df_stat,results='asis'}

stargazer(final_df,header = FALSE, omit.summary.stat = c("p25","p75","sd"))

```



\section{Results}

