---
title: "Work outline"
header-includes:
   - \usepackage{xcolor}
output: pdf_document
---

```{r setup, include=FALSE,}

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

```


```{r Load_libraries}

library(xts)

library(haven)

library(devtools)

library(tidyverse)

library(stargazer)

# library(texreg)

load_all()

```


```{r Set_parameters}

params_list = list()

params_list$x_vars = tolower(c("Illiq","Market_Cap_log","Turnover_log",
                               "Insider_ownership","HHI","IPO","Total_Assets",
                               "Operating_Profit","Revenue","Net_Profit",
                               "Equity","Total_Liabilities","Leverage"))

params_list$reg_vars = c("delisted","leverage","mb","capex_sales","roa",
                         "free_cash_flow","insider_ownership","size",
                         "log_trade_volume","illq")

```


```{r Import_data}

raw_df = read_dta(paste0(file.path(Sys.getenv("USERPROFILE"),fsep="\\"),
                     "\\OneDrive - Bank Of Israel\\Data\\TASE",
                     " liquidity\\Stata files\\TASE panel.dta")) %>% 
  rename_all(.funs = ~tolower(.))
  

names_table = read_csv(paste0(file.path(Sys.getenv("USERPROFILE"),
                                     fsep = "\\"),
                           "\\OneDrive - Bank Of Israel\\Data\\",
                           "TASE liquidity",
                           "\\convert_names_table.csv")) %>% 
  filter(old_name %in% names(raw_df))


df = raw_df %>% 
  rename_at(vars(names_table$old_name),~names_table$new_name) %>% 
  rename(date = newdate) %>% 
  mutate(date = as.yearqtr(date)) %>% 
  mutate(match = replace_na(match,0))


```


```{r Import_comps_list}

tase_comps_list = read_csv(paste0(file.path(Sys.getenv("USERPROFILE"),fsep = "\\"),
                                  "\\OneDrive - Bank Of Israel\\Data",
                                  "\\TASE liquidity\\",
                                  "TASE Comps list_revised.csv")) %>% 
  rename_all(tolower) %>% 
  mutate(tase_id = as.character(tase_id))

delisted_comps = tase_comps_list %>% 
  filter(delisted == 1) %>% 
  select(tase_id) %>% 
  mutate(tase_id = as_factor(tase_id)) %>% 
  arrange(tase_id)

```


\section{Introduction}

The purpose of the work is to identify the reasons
of firm's delistings from trade. The method is a logit regression that evaluates firm's characteristics in a sample
that consists of delisted firms and matched trading firms.

\section{Empirical specification}

\begin{align*}
	Pr(Delisting)  = \alpha & + \beta_{1} Leverage + \beta_{2} MB  
	                          + \beta_{3} CAPEX  + \beta_{4}ROA\\ 
	                        & + \beta{5} FreeCashFlow 
	                          + \beta_{6} InsiderOwnership \\
                          & + \beta_{7} Size + \beta_{8} TradeVolume 
                            + \beta_{9} Illiqudity
\end{align*}

Where:

\begin{itemize}
  \item
  \textcolor{red}{InsiderOwnership - currently using Public share (1-free float),
  maybe try your algorithm controlling shareholder data?}

\end{itemize}


\section{Descriptive Stats}


```{r df_stat,results='asis'}

stargazer(df %>% 
            select(any_of(params_list$reg_vars)) %>%  
            as.data.frame(),
          header = FALSE,
          omit.summary.stat = c("p25","p75"), digits = 2)

```

\subsection{Treatment vs Control}

```{r nimrods_matching}

nimrod_match_df = df %>% 
  select(tase_id, match, match_after_1996, treat, treat) %>% 
  distinct() %>% 
  rename(
    treat_tase_id = tase_id,
    control_tase_id = match,
    control_tase_id_after_1986 = match_after_1996) %>% 
  mutate(across(everything(), as.character))

```


```{r match_controls}

delisted_comps_list = unique(df$tase_id[df$delisted == 1])

michael_match_df = map(delisted_comps_list,
                    function(temp_delisted_comp){
  
  temp_crit = df %>% 
  filter(tase_id == temp_delisted_comp) %>% 
  select(date, market_cap) %>% 
  filter(complete.cases(.)) %>% 
  slice(1)
  
  
  match_df = df %>% 
  filter(!tase_id %in% delisted_comps_list) %>% 
  filter(delisted == 0) %>% 
  filter(date == temp_crit$date) %>% 
  select(tase_id, market_cap) %>% 
  mutate(diff = abs(market_cap/temp_crit$market_cap - 1)) %>% 
  select(-market_cap) %>% 
  arrange(diff) %>% 
  slice(1) %>% 
  mutate(treat_tase_id = temp_delisted_comp) %>% 
  rename(control_tase_id = tase_id)
    
return(match_df)
  
  
}) %>% 
  bind_rows()

michael_match_df = michael_match_df %>% 
  select(treat_tase_id, control_tase_id, diff) %>% 
  arrange(diff) %>% 
  filter(diff <= 0.1) %>% 
  select(-diff) %>% 
  mutate(across(c(treat_tase_id, control_tase_id),as.character))

rm(delisted_comps_list)

```


```{r split_to_treat_control}

control_treat_df


```


```{r table_3}

temp = df %>% 
  select(tase_id, date, total_assets, market_cap, leverage) %>% 
  filter(!is.na(date)) %>% 
  select(-date) %>%
  mutate(tase_id = as.character(tase_id)) %>% 
  mutate(across(c(total_assets,market_cap), ~. * 10 ^(-3))) %>%
  inner_join(michael_match_df %>% 
               pivot_longer(cols = everything(),
                           names_to = "type",
                           values_to = "tase_id") %>% 
              mutate(type = str_remove(type, "_tase_id")))

averages_df = temp %>% 
  select(-tase_id) %>% 
  group_by(type) %>% 
  summarise(across(everything(), mean, na.rm = TRUE))%>% 
            pivot_longer(cols = -"type", names_to = "Variable") %>% 
            pivot_wider(id_cols = Variable, names_from = type, values_from = value)


t_test_list = map(c("total_assets","market_cap","leverage"), function(temp_name){
  
  t.test(temp[temp$type == "treat",temp_name],
         temp[temp$type == "control",temp_name])
  
  
})


```


```{r }

averages_df %>% 
  pivot_longer(-Variable) %>% 
  ggplot(aes(x = Variable, y = value, fill = name)) + 
  geom_col(position = "dodge", width = 0.7) + 
  labs(x = "", y = "") + 
  facet_wrap(~Variable, scales = "free") +
  theme_bw() + 
  theme(legend.position = "bottom", legend.title = element_blank())
  

```


<!-- Model fit -->

```{r fit_model, eval=FALSE}

logit_mod = glm(delisted ~ .,
                     data = df %>% select(params_list$reg_vars),
                     family=binomial(link = "logit"))


```


```{r out_star, results="asis", eval=FALSE}


stargazer(logit_mod)


```



<!-- \section{Results} -->



<!-- \section{Appendix} -->

```{r ,child="Appendix.Rmd", eval = FALSE}

```

