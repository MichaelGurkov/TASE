---
title: "Datasets Description"
output: pdf_document
---


```{r setup, include=FALSE,}

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

```


```{r load_libraries}

library(devtools)

library(tidyverse)

library(xts)

library(lubridate)

library(stargazer)

library(MiscImport)

load_all()

```


```{r set_parameters}

raw_data = list()

parameters_list = list()

parameters_list$article_vars = c(
  "leverage",
  "mb",
  "roa",
  "free_cashflow",
  "insider_ownership",
  "intangible_assets",
  "size",
  "underpricing",
  "foreign_ipo",
  "vc_backing",
  "nomad_repitation",
  "turnover",
  "volume_log",
  "car",
  "stock_volatility",
  "beta",
  "seo",
  "quotation_life",
  "high_tech")

parameters_list$x_vars = c(
  "Illiq",
  "Market_Cap_log",
  "Turnover_log",  
  "Public_Share",
  "HHI",
  "IPO",
  "Total_Assets",
  "Operating_Profit",
  "Revenue",
  "Net_Profit",
  "Equity",
  "Total_Liabilities",
  "Leverage"
)


parameters_list$nimrod_vars = c(
  "tase_id",
  "tase_branch",
  "date",
  "leverage",
  "mb",
  "capex_to_revenue",
  "ipo_dummy",
  "roa",
  "free_cashflow",
  "insider_ownership",
  "size",
  "log_trade_volume",
  "turnover",
  "car_ipo_rr",
  "car_ipo_rf",
  "car_del_rr",
  "car_del_rf",
  "bet_ipo_rr",
  "bet_del_rr",
  "bet_ipo_rf",
  "bet_del_rf",
  "bet_qr_rr",
  "bet_qr_rf",
  "start_date_trading",
  "end_date_trading"
)


parameters_list$fin_rep_vars = c(
  "operating_profit",
  "net_profit",
  "equity",
  "revenue",
  "total_assets",
  "total_liabilities",
  "capex_cashflow",
  "operating_cashflow",
  "capex_to_revenue",
  "roa",
  "free_cashflow"
)



```

<!-- Import data -->

```{r import_secs_catalog}

secs_catalog = read_csv(paste0(Sys.getenv("USERPROFILE"),
                               "\\OneDrive - Bank Of Israel",
                               "\\Data\\TASE liquidity",
                               "\\Secs_Catalog.csv"),
                        col_types = paste0(rep("c",8), collapse = ""),
                        show_col_types = FALSE)

```


```{r import_delisted_comps_catalog}

delisted_comps = read_csv(paste0("C:\\Users\\internet",
                                 "\\OneDrive - Bank Of Israel",
                                 "\\Data\\TASE liquidity",
                                 "\\delisted_comps.csv"),
                          col_types = "cc",
                          show_col_types = FALSE) %>% 
  filter(!is.na(tase_id))

```


```{r import_temp_data}

raw_data = read_rds(paste0(
  file.path(Sys.getenv("USERPROFILE"),fsep="\\"),
  "\\OneDrive - Bank Of Israel\\Data\\TASE",
  " liquidity\\Current cache files\\raw_data.RDS"))

vars_status = read_csv(paste0(
  file.path(Sys.getenv("USERPROFILE"),fsep="\\"),
  "\\OneDrive - Bank Of Israel\\Data\\TASE",
  " liquidity\\Variables_List.csv"))

```


```{r Import_finrep_df, eval=FALSE}

finrep_file_path = paste0("C:\\Users\\internet",
                          "\\OneDrive - Bank Of Israel\\Data",
                          "\\TASE liquidity\\Rdata files",
                          "\\finrep_full_data_2022-11-15.rds")

finrep_raw = import_boi_oracle_finrep_data(filepath = finrep_file_path,
                                          data_frequency = "annual")



rm(finrep_file_path)

```


# Financial reports dataset

```{r fin}

finrep_df = finrep_raw %>%
  inner_join(select(delisted_comps, tase_id), by = "tase_id") %>% 
  mutate(date = year(date_yearqtr)) %>% 
  filter(date >= 2000) %>% 
  mutate(leverage = total_liabilities / total_assets) %>%
  mutate(capex_to_revenue =
           investing_activities / total_revenue) %>%
  mutate(roa = operating_profit / total_assets) %>%
  mutate(free_cashflow = operating_activities / total_assets) %>% 
  select(tase_id, date,leverage,capex_to_revenue,
         roa,free_cashflow, intangible_assets)


```



```{r intanible_assets_eda}

finrep_df %>% 
  select(date, intangible_assets) %>% 
  group_by(date) %>% 
  summarise(share_complete = sum(!is.na(intangible_assets)) /
              length(intangible_assets), .groups = "drop") %>% 
  ggplot(aes(date, share_complete)) + 
  geom_col()

```

# Market dataset


```{r Import_market_data, eval=FALSE}

market_file_path = paste0(Sys.getenv("USERPROFILE"),
                          "\\OneDrive - Bank Of Israel\\Data",
                          "\\TASE liquidity\\Rdata files",
                          "\\market_data.rds")

market_df = import_boi_market_data(market_file_path) %>% 
  make_market_df()


rm(market_file_path)

temp = market_df %>% 
  filter(date_yearqtr >= as.yearqtr("2000 Q4")) %>% 
  inner_join(secs_catalog %>% 
               select(tase_id, sec_id) %>%
               distinct() %>% 
               inner_join(select(delisted_comps, tase_id),
                          by = "tase_id"))


skimr::skim_without_charts(temp)

```


```{r}

market_df %>% 
  filter(security_ident_num_tase == "00662577") %>% 
  mutate(date_value = as_date(date_value)) %>% 
  mutate(close_rate_adj = as.numeric(close_rate_adj)) %>% 
  ggplot(aes(date_value, close_rate_adj)) + 
  geom_line()

```


Fin reports data from oracle 

<!-- Process data -->

```{r make_reg_df}


df = make_reg_df(
  market_df = raw_data$market_df,
  finrep_df = raw_data$finrep_df %>% 
    select(-market_value),
  secs_catalog = secs_catalog)

df = df %>% 
  mutate(across(c(leverage, roa, mb, free_cashflow), ~ na_if(., Inf))) %>%
  mutate(across(c(volume_log, roa,free_cashflow), ~ na_if(., -Inf)))


```



```{r vars_list, results="asis"}

stargazer(vars_status %>% 
            arrange(Status) %>% 
            as.data.frame(),
          header = FALSE,
          summary = FALSE,
          rownames = FALSE,
          title = "List of variables used in KashefiPour2013")

```

This dataset has data on financial reports of TASE companies.
The data covers `r length(unique(df$tase_id))` companies for the period `r paste0(range(df$date_yearqtr), collapse = "-")` at quarterly frequency. 


```{r summary_df, results="asis"}

stargazer(df %>% 
            select(-any_of(c("sec_id", "tase_id", "date_yearqtr"))) %>% 
            as.data.frame(),
          header = FALSE,
          digits = 3,
          summary = TRUE,
          title = "Summary statistics of regression data set")

```




\section{Appendix}

