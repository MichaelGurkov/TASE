---
title: "Datasets Description"
output: pdf_document
---


```{r setup, include=FALSE,}

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

```


```{r load_libraries}

library(devtools)

library(tidyverse)

library(xts)

library(lubridate)

library(stargazer)

load_all()

```


```{r set_parameters}

features_list = list()

features_list$x_vars = c("Illiq","Market_Cap_log","Turnover_log",
                         "Public_Share","HHI","IPO",
                         "Total_Assets","Operating_Profit","Revenue",
                         "Net_Profit","Equity",
                         "Total_Liabilities","Leverage")

features_list$fin_rep_vars = c("operating_profit","net_profit","equity",
                               "revenue","total_assets",
                               "total_liabilities","capex_cashflow",
                               "operating_cashflow","capex_to_revenue",
                               "roa","free_cashflow")

features_list$market_vars = c("illiq","turnover","market_cap","public_share")




```


```{r Import_comps_list}

tase_comps_list = read_csv(paste0(file.path(Sys.getenv("USERPROFILE"),fsep = "\\"),
                                  "\\OneDrive - Bank Of Israel\\Data",
                                  "\\TASE liquidity\\",
                                  "TASE Comps list_revised.csv")) %>% 
  rename_all(tolower) %>% 
  mutate(tase_id = as.character(tase_id))

```



\subsection{Nimrod's dataset}

```{r Import_nimrod_dataset, eval=FALSE}

old_df = import.old.regression.data()

old_df = old_df %>% 
  mutate(ROA = Operating_Profit / Total_Assets)




```


```{r import_stata_df}

library(haven)

raw_stata_df = read_dta(paste0(file.path(Sys.getenv("USERPROFILE"),
                                     fsep = "\\"),
                           "\\OneDrive - Bank Of Israel\\Data\\",
                           "TASE liquidity\\Stata files",
                           "\\TASE panel.dta")) %>% 
  rename_all(tolower)

names_table = read_csv(paste0(file.path(Sys.getenv("USERPROFILE"),
                                     fsep = "\\"),
                           "\\OneDrive - Bank Of Israel\\Data\\",
                           "TASE liquidity",
                           "\\convert_names_table.csv")) %>% 
  filter(old_name %in% names(raw_stata_df))

stata_df = raw_stata_df %>% 
  filter(!is.na(newdate)) %>% 
  rename_at(vars(names_table$old_name),~names_table$new_name) %>% 
  rename(date = newdate) %>% 
  mutate(date = as.yearqtr(date)) %>% 
  mutate(tase_id = as.character(tase_id)) %>% 
  mutate(tase_branch = as_factor(tase_branch))

rm(names_table)

```


A dataset that was gathered by Nimrod . The data time period is `r paste0(range(stata$date), collapse = "-")` at quarterly frequency.
The data adresses several categories:

\begin{itemize}
  \item
  Financial Reports
  \item
  Market data
\end{itemize}

```{r summary_old_df, results='asis', eval=FALSE}

stargazer(old_df %>% 
            select(-Date), summary = TRUE, header = FALSE, digits = 2)

```


\subsection{Financial reports}

```{r Import_finrep_df}

finrep_df = read_rds(paste0(file.path(Sys.getenv("USERPROFILE"),
                                            fsep="\\"),
                                  "\\OneDrive - Bank Of Israel\\Data",
                                  "\\TASE liquidity\\finrep_df.Rds"))


finrep_df = finrep_df %>% 
  rename_all(tolower)

```

This dataset has data on financial reports of TASE companies. The data time period is `r paste0(range(finrep_df$Date), collapse = "-")` at quarterly frequency.

```{r summary_df, results='asis', eval=FALSE}

stargazer(finrep %>% 
            select(-Date, -TASE_ID,-TASE_branch),
          summary = TRUE, header = FALSE, digits = 2)

```


\subsubsection{Comparison of financial reports data}

```{r compare_financial_reports_data}

fin_comparison_df = list(finrep_df %>% 
                       select(any_of(c(features_list$fin_rep_vars,
                                       "date",
                                       "tase_id"))) %>% 
                       pivot_longer(cols = c(-date, -tase_id),
                                    names_to = "feature",
                                    values_to = "finrep"),
                     stata_df %>% 
                       select(any_of(c(features_list$fin_rep_vars,
                                       "date",
                                       "tase_id"))) %>% 
                       mutate(across(where(is.numeric) &
                                       !capex_to_revenue &
                                       !roa,
                                     ~. * 10 ^ (-3))) %>% 
                       pivot_longer(cols = c(-date, -tase_id),
                                    names_to = "feature",
                                    values_to = "stata")) %>% 
  reduce(inner_join, by = c("date","tase_id","feature")) %>% 
  filter(complete.cases(.))



fin_comparison_summary = fin_comparison_df %>% 
  group_by(tase_id, feature) %>% 
  summarise(avg_diff = mean(abs(finrep - stata) /
                              (0.5 * (finrep + stata)), na.rm = TRUE) * 100,
            .groups = "drop") %>% 
  arrange(-avg_diff)


```


```{r plot_fin_rep_diff, eval=FALSE}

fin_comparison_df %>% 
  filter(tase_id == fin_comparison_summary$tase_id[1]) %>% 
  filter(feature == fin_comparison_summary$feature[1]) %>% 
  pivot_longer(cols = c("finrep","stata")) %>% 
  ggplot(aes(x = date, y = value, color = name)) + 
  geom_point() + 
  geom_line() + 
  theme_bw() + 
  theme(legend.position = "bottom")

```

The comparison reveals that some data points are equal between
financial reports data and Nimrod's stata file, In cases where there is
a difference Nimrod data seems to be much more volatile with extreme
values

\subsection{Market data}

\subsubsection{Comparison of market data}

```{r Import_market_data}

market_df = read_rds(paste0(file.path(Sys.getenv("USERPROFILE"),
                                            fsep="\\"),
                                  "\\OneDrive - Bank Of Israel\\Data",
                                  "\\TASE liquidity\\market_df.Rds")) %>% 
  ungroup() %>% 
  rename_all(tolower) %>% 
  rename(tase_id = comp_id)

market_df = market_df %>%
  ungroup() %>% 
  filter_at(vars(Market_Cap, Turnover, Illiq),
            .vars_predicate = all_vars(is.finite(.)))



```

A dataset with market data (market capitalization, turnover) that allows to calculate Amihud's iiliquidity measure. The data time period is `r paste0(range(market_df$Date), collapse = "-")` at quarterly frequency.

```{r summary_market_df, results='asis', eval=FALSE}

stargazer(market_df %>% 
            select(-Date, -Comp_ID, - Sec_ID) %>% 
            as.data.frame() %>% 
            mutate_at(vars(Market_Cap, Turnover),.funs = list(~. * 10 ^ (-3))),
          summary = TRUE, header = FALSE, digits = 2)

```

```{r comps_with_multiple_secs_check}

comps_mult_secs_list = market_df %>% 
  select(tase_id, sec_id) %>% 
  distinct() %>% 
  filter(tase_id %in% tase_id[duplicated(tase_id)])

```


```{r compare_market_data}

market_comparison_df = list(market_df %>% 
                       select(any_of(c(features_list$market_vars,
                                       "date",
                                       "tase_id"))) %>% 
                       pivot_longer(cols = c(-date, -tase_id),
                                    names_to = "feature",
                                    values_to = "oracle"),
                     stata_df %>% 
                       select(any_of(c(features_list$market_vars,
                                       "date",
                                       "tase_id"))) %>% 
                       pivot_longer(cols = c(-date, -tase_id),
                                    names_to = "feature",
                                    values_to = "stata")) %>% 
  reduce(inner_join, by = c("date","tase_id","feature")) %>% 
  filter(complete.cases(.))



market_comparison_summary = market_comparison_df %>% 
  group_by(tase_id, feature) %>% 
  summarise(avg_diff = mean(abs(oracle - stata) /
                              (0.5 * (oracle + stata)), na.rm = TRUE) * 100,
            .groups = "drop") %>% 
  arrange(-avg_diff)


```


```{r plot_market_data_diff, eval=FALSE}

market_comparison_df %>% 
  filter(tase_id == market_comparison_summary$tase_id[1]) %>% 
  filter(feature == market_comparison_summary$feature[1]) %>% 
  pivot_longer(cols = c("oracle","stata")) %>% 
  ggplot(aes(x = date, y = value, color = name)) + 
  geom_point() + 
  geom_line() + 
  theme_bw() + 
  theme(legend.position = "bottom")

```

Comparison of market data reveals similar results , Nimrod's data is more volatile
and extreme
