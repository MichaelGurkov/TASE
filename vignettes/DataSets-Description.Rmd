---
title: "Datasets Description"
output: pdf_document
---


```{r setup, include=FALSE,}

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

```


```{r load_libraries}

library(devtools)

library(tidyverse)

library(xts)

library(lubridate)

library(stargazer)

library(MiscImport)

load_all()

```

<!-- Import data -->

```{r import_secs_catalog}

secs_catalog = read_csv(paste0("C:\\Users\\Home",
                               "\\OneDrive - Bank Of Israel\\Data",
                               "\\TASE\\Secs_Catalog.csv"),
                        col_types = "cccccccc",
                        show_col_types = FALSE)

vars_list = read_csv(paste0("C:\\Users\\Home",
                            "\\OneDrive - Bank Of Israel\\Data",
                            "\\TASE liquidity\\michael files",
                            "\\Variables_List.csv"),
                     show_col_types = FALSE)


```

# Financial reports dataset

```{r finrep_df}

raw_finrep_vars = vars_list %>% 
  filter(data_source == "finrep") %>% 
  filter(category == "raw") %>% 
  pull(df_varname)


final_finrep_vars = vars_list %>% 
  filter(data_source == "finrep") %>% 
  filter(category == "final") %>% 
  pull(df_varname)



finrep_path = paste0(Sys.getenv("USERPROFILE"),
                     "\\OneDrive - Bank Of Israel\\Data",
                     "\\TASE liquidity\\Rdata files\\finrep_full_data",
                     "_2022-11-15.rds")

raw_oracle_finrep_df = import_boi_oracle_finrep_data(finrep_path,
                                          data_frequency = "quarterly")

finrep_df = raw_oracle_finrep_df %>% 
  make_finrep_oracle_df(raw_finrep_vars = raw_finrep_vars,
                        final_finrep_vars = final_finrep_vars)


rm(finrep_path,raw_finrep_vars,final_finrep_vars,raw_oracle_finrep_df)

```


```{r plot_missing_value_structure}

finrep_df %>% 
  map_dbl(.,~sum(is.na(.)) / length(.)) %>% 
  as_tibble() %>% 
  mutate(col_names = names(finrep_df)) %>% 
  ggplot(aes(value, reorder(col_names, value))) + 
  geom_col() + 
  scale_x_continuous(labels = scales::percent_format()) + 
  xlab(NULL) + ylab(NULL) + ggtitle("Missing structure of finrep df")

```



# Market dataset

```{r Import_market_data}

raw_market_vars = vars_list %>% 
  filter(data_source == "market_data") %>% 
  filter(category == "raw") %>% 
  pull(df_varname)


final_market_vars = vars_list %>% 
  filter(data_source == "market_data") %>% 
  filter(category == "final") %>% 
  filter(!df_varname == "car") %>% 
  pull(df_varname)


market_file_path = paste0(Sys.getenv("USERPROFILE"),
                          "\\OneDrive - Bank Of Israel\\Data",
                          "\\TASE liquidity\\Rdata files",
                          "\\market_data_2022-11-15.rds")


raw_oracle_market_df = import_boi_market_data(market_file_path)

market_df = raw_oracle_market_df %>% 
  make_market_df()

final_market_vars[!final_market_vars %in% names(market_df)]


rm(market_file_path,raw_oracle_market_df)


```


```{r plot_missing_value_structure}

market_df %>% 
  map_dbl(.,~sum(is.na(.)) / length(.)) %>% 
  as_tibble() %>% 
  mutate(col_names = names(market_df)) %>% 
  ggplot(aes(value, reorder(col_names, value))) + 
  geom_col() + 
  scale_x_continuous(labels = scales::percent_format()) + 
  xlab(NULL) + ylab(NULL) + ggtitle("Missing structure of market df")

```


```{r complete_market_data_from_legacy_data_sources, eval=FALSE}

legacy_market_df = read_rds(paste0(Sys.getenv("USERPROFILE"),
                     "\\OneDrive - Bank Of Israel\\Data",
                     "\\TASE liquidity\\Rdata files\\final_df.RDS")) %>% 
  rename_all(tolower)

legacy_market_df = legacy_market_df %>% 
  rename(size = market_cap_log) %>% 
  select(sec_id, date, any_of(final_market_vars))


```



# Final dataset

```{r make_reg_df}

final_vars = vars_list %>% 
  filter(category == "final") %>% 
  filter(status == "present") %>% 
  pull(df_varname)


df = make_reg_df(market_df = market_df,
                 finrep_df = finrep_df,
                 final_vars = final_vars)

df = df %>% 
  mutate(across(c(leverage, roa, mb, free_cashflow), ~ na_if(., Inf))) %>%
  mutate(across(c(volume, roa,free_cashflow), ~ na_if(., -Inf)))

# df = df %>% 
#   filter(date <= as.yearqtr("2020 Q1"))

```

```{r missing_structure}

map_dbl(df,~sum(is.na(.))/length(.)) %>% 
  as_tibble() %>% 
  mutate(col_name = names(df)) %>% 
  ggplot(aes(value, reorder(col_name, value))) + 
  geom_col() + 
  scale_x_continuous(labels = scales::percent_format()) + 
  xlab(NULL) + ylab(NULL) + ggtitle("Missing data in final df")
```

## Complete final dataset from legacy data


```{r Import_legacy_df}


legacy_df = read_rds(paste0(Sys.getenv("USERPROFILE"),
                     "\\OneDrive - Bank Of Israel\\Data",
                     "\\TASE liquidity\\Rdata files\\final_df.RDS")) %>% 
  rename_all(tolower)

# names(df)[!names(df) %in% names(legacy_df)]

legacy_df = legacy_df %>% 
  rename(size = market_cap_log)



```



```{r complete_df_with_legacy_df}

df = df %>% 
  pivot_longer(-c("tase_id","date")) %>% 
  left_join(legacy_df %>% 
              select(any_of(names(df))) %>% 
              pivot_longer(-c("tase_id","date")),
            by = c("tase_id","date","name"), suffix = c("_df","_legacy")) %>% 
  mutate(final_value = coalesce(value_df, value_legacy)) %>% 
  select(-c("value_df","value_legacy")) %>% 
  pivot_wider(id_cols = c("tase_id","date"),
              names_from = "name", values_from = "final_value")

rm(legacy_df)

```


```{r import_nimrod_df}

nimrod_filepath = paste0(Sys.getenv("USERPROFILE"),
                         "\\OneDrive - Bank Of Israel\\Data",
                         "\\TASE liquidity\\Stata files",
                         "\\ahzakot.dta")

nimrod_df = import.nimrod.stata.df(nimrod_filepath)

```




```{r compare_comp, eval=FALSE}

comp_id = "281"

alice = df %>% 
  filter(tase_id == comp_id) %>% 
  select(date, 
  illiq,
  leverage,
  mb,
  turnover)


bob = old_df %>% 
  filter(tase_id == comp_id) %>% 
  select(date, 
  illiq,
  leverage,
  mb,
  turnover)

alice %>% 
  pivot_longer(-date) %>% 
  full_join(bob %>% 
              mutate(across(c("mb","turnover"), ~ .* 10 ^ -6)) %>% 
              pivot_longer(-date) %>% 
              mutate(value = as.numeric(value)),
            by = c("date","name"),
            suffix = c("_alice","_bob")) %>% 
  pivot_longer(cols = starts_with("value"),names_to = "source") %>% 
  ggplot(aes(date, value, color = source)) + 
  geom_line() + 
  facet_wrap(~name, scales = "free")

```




# Save final df

```{r save_final_df, eval=FALSE}

df %>% 
  write_rds(paste0("C:\\Users\\Home",
                   "\\OneDrive - Bank Of Israel\\Data",
                   "\\TASE liquidity\\Rdata files\\final_df_",
                   Sys.Date(),".rds"))

```

