
\subsection{Buy-and-Hold returns}

\subsection{Buy-and-Hold returns using a market index}

```{r match_market_index}

market_index_match_table = stocks_ipo %>% 
  select(id_ipo = tase_id) %>% 
  distinct() %>% 
  mutate(id_control = "ta_125")

price_df = clean_market_df %>% 
  select(-target_value) %>% 
  bind_rows(ta_125 %>% 
              rename(price = ta_125) %>% 
              mutate(id = "ta_125"))

market_index_matched_df = merge_ipo_control_prices(price_df = price_df,
                            matched_sample = market_index_match_table)


rm(market_index_match_table, price_df)

```

```{r sanity_check_market_index,eval=FALSE}

ta125_match %>% 
  filter(id == 1420) %>% 
  select(date, contains("price")) %>% 
  pivot_longer(-date) %>% 
  group_by(name) %>% 
  mutate(value = value / value[date == min(date)]) %>% 
  ungroup() %>% 
  ggplot(aes(date, value, color = name)) + 
  geom_line() + 
  xlab(NULL) + ylab(NULL) + ggtitle("Azrieli group vs TA 125")
  theme(legend.title = element_blank())

```


```{r calculate_bhar_market_daily}

bhar_market_daily = map_dfr(c(1,3,5), function(temp_horizon){
  
  temp_df = market_index_matched_df %>% 
    calculate_bhar_from_price_df(target_duration = 252 * temp_horizon,
                                 duration_tolerance = 0.02) %>% 
    mutate(horizon = temp_horizon)
  
  
  
  
})


```

```{r sanity_check_bhar_calculation, eval=FALSE}

market_index_matched_df %>% 
  filter(id == 1240) %>% 
  mutate(date = date - min(date)) %>% 
  filter(date == 0 | date <= 252) %>% 
  slice(1, nrow(.)) %>% 
  summarise(across(contains("price"), ~.[2]/.[1]-1)) %>% 
  rename_with(~str_replace(.,"price","bhar")) %>% 
  all.equal(bhar_market_daily %>% 
              filter(id == 1240) %>% 
              filter(horizon == 1) %>% 
              select(bhar_ipo, bhar_control))

```

```{r plot_bhar_market_daily_dist}

bhar_market_daily %>% 
  ggplot(aes(x = bhar_abnormal)) + 
  geom_density() + 
  facet_wrap(~horizon) + 
  xlab(NULL) + ylab(NULL)

bhar_market_daily %>% 
  group_by(horizon) %>% 
  filter(bhar_abnormal == max(bhar_abnormal))

```


\subsubsection{Buy-and-Hold returns using control matched by market cap}


```{r match_multiple_control_firm_by_size}

ipo_comps = stocks_ipo %>%
    select(id = tase_id) %>%
    distinct()

market_target_df = clean_market_df %>% 
  select(-price) %>% 
  filter(complete.cases(.))

market_size_match_table = match_by_target_value(ipo_comps = ipo_comps,
                                                target_df = market_target_df,
                                                age_threshold = 1 * 252,
                                                single_match = FALSE)

multiple_firms_match = merge_ipo_control_prices(clean_market_df %>%
                                                  select(-target_value),
                                                market_size_match_table)

```


```{r calculate_bhar_size_matched_comps_daily}

bhar_multiple_firms_daily = map_dfr(c(1,3,5), function(temp_horizon){
  
  temp_df = multiple_firms_match %>% 
    calculate_bhar_from_price_df(target_duration = 252 * temp_horizon,
                                 duration_tolerance = 0.02) %>% 
    mutate(horizon = temp_horizon)
  
  
  
  
})


```


```{r sanity_check_bhar_calculation, eval=FALSE}

multiple_firms_match %>% 
  filter(id == 1819) %>% 
  filter(id_control == 345) %>% 
  mutate(date = date - min(date)) %>% 
  filter(date == 0 | date <= 3 * 252) %>% 
  slice(1, nrow(.)) %>% 
  summarise(across(contains("price"), ~.[2]/.[1]-1)) %>% 
  rename_with(~str_replace(.,"price","bhar")) %>% 
  all.equal(bhar_multiple_firms_daily %>% 
              filter(id == 1819) %>% 
              filter(id_control == 345) %>% 
              filter(horizon == 3) %>% 
              select(bhar_ipo, bhar_control))

```


```{r plot_bhar_matched_comps_daily_dist}

bhar_multiple_firms_daily %>% 
  group_by(id, horizon) %>% 
  summarise(bhar_abnormal = mean(bhar_abnormal), .groups = "drop") %>% 
  ggplot(aes(x = bhar_abnormal)) + 
  geom_density() + 
  facet_wrap(~horizon) + 
  xlab(NULL) + ylab(NULL)

bhar_multiple_firms_daily %>% 
  group_by(id, horizon) %>% 
  summarise(bhar_abnormal = mean(bhar_abnormal), .groups = "drop") %>% 
  filter(bhar_abnormal == min(bhar_abnormal))

```


\subsubsection{Match by book to market}

```{r match_multiple_control_firm_by_book_to_market}

book_to_market_match_table = match_by_target_value(ipo_comps = ipo_comps,
                                                target_df = finrep_df,
                                                age_threshold = 1,
                                                single_match = FALSE)


book_to_market_matched_df = merge_ipo_control_prices(clean_market_df %>%
                                                  select(-target_value),
                                                book_to_market_match_table)

```


```{r calculate_bhar_book_to_market_matched_comps_daily}

bhar_book_to_market = map_dfr(c(1,3,5), function(temp_horizon){
  
  temp_df = book_to_market_matched_df %>% 
    calculate_bhar_from_price_df(target_duration = 252 * temp_horizon,
                                 duration_tolerance = 0.02) %>% 
    mutate(horizon = temp_horizon)
  
  
  
  
})


```


```{r sanity_check_bhar_calculation, eval=FALSE}

book_to_market_matched_df %>% 
  filter(id == 1103) %>% 
  filter(id_control == 669) %>% 
  mutate(date = date - min(date)) %>% 
  filter(date == 0 | date <= 1 * 252) %>% 
  slice(1, nrow(.)) %>% 
  summarise(across(contains("price"), ~.[2]/.[1]-1)) %>% 
  rename_with(~str_replace(.,"price","bhar")) %>% 
  all.equal(bhar_book_to_market %>% 
              filter(id == 1103) %>% 
              filter(id_control == 669) %>% 
              filter(horizon == 1) %>% 
              select(bhar_ipo, bhar_control))

```


```{r plot_bhar_book_to_market_dist}

bhar_book_to_market %>% 
  group_by(id, horizon) %>% 
  summarise(bhar_abnormal = mean(bhar_abnormal), .groups = "drop") %>% 
  ggplot(aes(x = bhar_abnormal)) + 
  geom_density() + 
  facet_wrap(~horizon) + 
  xlab(NULL) + ylab(NULL)


```

