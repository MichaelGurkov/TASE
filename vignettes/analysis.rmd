

```{r labels}

raw_ipo_dist_lab = "Raw IPO returns distribution \\label{raw_ipo_dist_fig}"

```


```{r attrition, results='asis'}

duration_table = market_df %>% 
  inner_join(stocks_ipo %>% 
               select(tase_id) %>% 
               distinct(), by = "tase_id") %>% 
  unite(c("tase_id", "sec_id"), col = "id") %>% 
  select(date, id, close_adjusted) %>% 
  filter(complete.cases(.)) %>% 
  group_by(id) %>% 
  arrange(date) %>% 
  mutate(duration = (as.numeric(date - min(date)) %/% (21 * 12)) + 1) %>% 
  ungroup() %>% 
  select(id, duration) %>% 
  filter(duration <= 5) %>% 
  distinct()

attrition_table = duration_table %>% 
  group_by(id) %>% 
  summarise(delisted_period = 5 - max(duration), .groups = "drop") %>% 
  filter(delisted_period > 0)

duration_table %>% 
  count(duration, sort = TRUE, name = "comps_num") %>% 
  mutate(comps_share = (comps_num / comps_num[duration == 1]) * 100) %>% 
  rename(Year = duration, `Number of firms` = comps_num,
         `Fraction of firms remaining` = comps_share) %>% 
  stargazer(header = FALSE,summary = FALSE,digits = 2,
            title = "Firms attrition")




```

\subsection{Buy-and-Hold returns using a portfolio of matched firms}

<!-- daily calculation -->

```{r match_multiple_control_firm_by_size_multiple}

matched_sample_multiple = match_comps_by_market_value(stocks_ipo %>%
                                                        select(tase_id) %>%
                                                        distinct(),
                                                      market_df,
                                                      single_match = FALSE)

price_df_multiple = make_price_df(market_df, matched_sample_multiple)

```

```{r compare_ipo_and_control, results='asis'}

ipo_ids = market_df %>% 
  unite(col = "id", c("tase_id", "sec_id")) %>% 
  inner_join(matched_sample_multiple %>% 
               select(id_ipo) %>% 
               distinct(), by = c("id" = "id_ipo")) %>% 
  group_by(id) %>% 
  summarise(market_value = market_value[date == min(date)],
            date = min(date),
            .groups = "drop")


control_ids = matched_sample_multiple %>% 
  left_join(ipo_ids %>% 
              select(id, date), by = c("id_ipo" = "id")) %>% 
  left_join(market_df %>% 
              unite(col = "id_control",c("tase_id","sec_id")) %>% 
              select(id_control, date, market_value),
            by = c("id_control","date"))


tibble(IPOs = c(ipo_ids$market_value,
                   rep(NA,nrow(control_ids) - nrow(ipo_ids))),
           Control = control_ids$market_value) %>% 
  mutate(across(everything(),~.*10^-6)) %>% 
  as.data.frame() %>% 
  stargazer(header = FALSE, digits = 1,
            title = "Comparison of market value in IPOs and control firms")

```

```{r calculate_returns_size_control}


bhar_daily_multiple = map_dfr(c(3,5), function(temp_horizon){
  
  temp_df = price_df_multiple %>% 
    calculate_bhar_from_price_df(target_duration = 252 * temp_horizon) %>% 
    mutate(horizon = temp_horizon)
  
  
  
  
})

bhar_daily_multiple = bhar_daily_multiple %>% 
  group_by(id, horizon) %>% 
  summarise(across(contains("bhar"), mean),.groups = "drop")

period_ret_multiple = calculate_period_ret_from_price_df(price_df_multiple,
                                                         period_freq = 252,
                                                         period_thresh = 5)


```

```{r size_matched_params, eval=FALSE}

size_matched_ipo


```

In this section I compute the three and five years buy-and-hold abnormal returns using control firms matched by size as benchmark. The matching procedure results in `r length(unique(matched_sample_multiple$id_ipo))` IPOs each compared with a portfolio of similar size firms. The raw IPO returns are negative in both horizons, the distribution of the raw returns is highly right skewed meaning that there are few highly performing firms where is the majority of the firms is characterized with negative returns (Figure \ref{raw_ipo_dist_fig})



```{r plot_ipo_raw_returns_dist, fig.cap=raw_ipo_dist_lab}

bhar_daily_multiple %>% 
  ggplot(aes(x = bhar_ipo)) + 
  geom_histogram() + 
  geom_vline(xintercept = 0, color = "blue", linetype = "dashed") + 
  facet_wrap(~horizon, scales = "free") + 
  scale_x_continuous(labels = scales::percent_format()) + 
  xlab("Raw IPO returns") + ylab(NULL) + 
  ggtitle("Raw IPO returns distribution")

```


```{r plot_period_returns, eval=FALSE}

period_ret_multiple %>% 
  group_by(period) %>% 
  summarise(ret_abnormal = mean(ret_abnormal), .groups = "drop") %>% 
  ggplot(aes(period, ret_abnormal)) + 
  geom_col(width = 0.5) + 
  scale_y_continuous(labels = scales::percent_format()) + 
  xlab("Years since IPO") + ylab(NULL) + 
  ggtitle("Average annual abnormal return")

```

```{r output_table_bhar_daily_multiple, results='asis'}

bhar_daily_multiple %>% 
  group_by(horizon) %>% 
  summarise(across(c(contains("bhar")), ~mean(.) * 100)) %>% 
  rename(Horizon = horizon,
         `IPOs raw return` = bhar_ipo,
         `Control firms raw return` = bhar_control,
         `Abnormal return` = bhar_abnormal) %>% 
  as.data.frame() %>% 
  stargazer(summary = FALSE, header = FALSE, digits = 2,
            title = "Buy-and-Hold abnormal returns")


```

\subsection{Buy-and-Hold returns using a market index}

```{r match_market_index}

price_df_market = market_df %>% 
  select(tase_id, sec_id, date, price_ipo = close_adjusted) %>% 
  inner_join(stocks_ipo %>% 
               select(tase_id) %>% 
               distinct(), by = "tase_id") %>% 
  unite(c("tase_id","sec_id"),col = "id") %>% 
  left_join(ta_125 %>% 
              rename(price_control = ta_125) %>% 
              mutate(id_control = "ta_125"), by = "date") %>% 
  filter(complete.cases(.))





```

```{r calculate_returns_market_control}


bhar_daily_multiple_market = map_dfr(c(3,5), function(temp_horizon){
  
  temp_df = price_df_market %>% 
    calculate_bhar_from_price_df(target_duration = 252 * temp_horizon) %>% 
    mutate(horizon = temp_horizon)
  
  
  
  
})

bhar_daily_multiple_market = bhar_daily_multiple_market %>% 
  group_by(id, horizon) %>% 
  summarise(across(contains("bhar"), mean),.groups = "drop")

period_ret_multiple_market = calculate_period_ret_from_price_df(price_df_market,
                                                         period_freq = 252,
                                                         period_thresh = 5)


```

This sections uses a market index as a benchmark for computing abnormal buy-and-hold returns. There are 370 IPOs


```{r output_table_bhar_daily_multiple_market, results='asis'}

bhar_daily_multiple_market %>% 
  group_by(horizon) %>% 
  summarise(across(c(contains("bhar")), ~mean(.) * 100)) %>% 
  rename(Horizon = horizon,
         `IPOs raw return` = bhar_ipo,
         `Control firms raw return` = bhar_control,
         `Abnormal return` = bhar_abnormal) %>% 
  as.data.frame() %>% 
  stargazer(summary = FALSE, header = FALSE, digits = 2,
            title = "Buy-and-Hold abnormal returns")


```
