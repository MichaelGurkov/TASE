---
title: "TASE companies evolution"
output: pdf_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE,error = FALSE,
                      message = FALSE, warning = FALSE)

```


```{r Load_libraries}

library(tidyverse)

library(xts)

library(stargazer)

library(readxl)

devtools::load_all()

```


```{r Import_data}


status_df = import_TASE_comps_status()

price_df = map_dfr(c("TA35","TA125"), function(temp_name){
  
  file_path = paste0(Sys.getenv("USERPROFILE"),
                       "\\OneDrive - Bank Of Israel",
                       "\\Data\\TASE liquidity",
                       "\\",temp_name,".csv")
  
  temp_df = read_csv(file_path,col_names = c("date", "basis", "open", "close",
                                        "high", "low", "market_cap"),
                show_col_types = FALSE, skip = 1) %>%
  mutate(date = dmy(date)) %>% 
  group_by(year = year(date)) %>% 
  summarise(avg_close = mean(close), .groups = "drop") %>% 
  mutate(index_type = temp_name)

  return(temp_df)
  
  
  
})



```


```{r plot_comps_evolution}

status_df %>% 
  filter(sector == "Total") %>% 
  ggplot(aes(year, end_year)) + 
  geom_col() + 
  geom_text(aes(x = year, y = end_year, label = end_year), vjust = -1,
            color = "magenta", size = 3) + 
  xlab(NULL) + ylab(NULL) + ggtitle("Number of listed companies in TASE")

# comps_evolution_plot = ggplot(status_df %>% 
#                                 filter(sector == "Total"),
#                               aes(x = year, y = end_year, group = 1)) + 
#   geom_col(width = 0.7) + 
#   geom_text(aes(x = year, y = end_year, label = end_year), vjust = -1,
#             color = "magenta", size = 3) + 
#   labs(x = "", y = "", title = "Number of listed companies in TASE") + 
#   theme_bw() + 
#   theme(plot.title = element_text(hjust = 0.5),
#         axis.text.x = element_text(angle = 90, vjust = 0.5))
# 
# y_range = ggplot_build(comps_evolution_plot)$layout$panel_params[[1]]$y.range
# 
# y_range[2] = 1.05 * y_range[2]
# 
# print(comps_evolution_plot + 
#         ylim(y_range))
# 
# rm(y_range)

```

Number of listed companies has been declining since it peaked at 2007-2008, there are currently 
`r status_df$end_year[status_df$sector == "Total" & status_df$year == max(status_df$year)]` listed
on the exchange.The average number has been `r mean(status_df$end_year[status_df$sector == "Total"])`
companies.

```{r plot_net_new_comps_evolution}


status_df %>% 
  filter(sector == "Total Shares") %>% 
  select(year, issued_comps, delisted_comps) %>% 
  mutate(net_new_comps = issued_comps - delisted_comps) %>% 
  mutate(delisted_comps = -1 * delisted_comps) %>% 
  pivot_longer(-c(year, net_new_comps)) %>% 
  ggplot() + 
  geom_col(aes(year, value, fill = name)) +
  geom_line(aes(year, net_new_comps, group = 1,
            color = "Net new comps")) + 
  scale_color_manual(values = "black") + 
  xlab(NULL) + ylab(NULL) + 
  theme(legend.title = element_blank())
  
  



```


```{r plot_comps_evolution_by_sectype}

ggplot(status_df %>% 
  filter(sector %in% c("Total Shares","Total Bonds")),
  aes(x = year, y = end_year, group = sector, fill = sector)) + 
  geom_col(position = "dodge") + 
  labs(x = "", y = "", title = "Number of listed companies in TASE") + 
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5), legend.position = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5))

```


```{r plot_comps_evolution_by_sector}

ggplot(status_df %>% 
  filter(!sector %in% grep("Total",unique(sector),value = TRUE)),
  aes(x = year, y = end_year, group = sector, fill = sector, label = end_year)) + 
  geom_bar(stat = "identity") + 
  # geom_text(size = 3, position = position_stack(vjust = 0.5)) + 
  scale_fill_brewer(type = "div", palette = "Spectral") + 
  labs(x = "", y = "", title = "Number of listed companies in TASE \n (by sector)") + 
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5), legend.position = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5), legend.title = element_blank())

```

A study of sector evolution reveals that the most prominent and stable sectors are: industry,
real estate, services and holdings. However in the last 5 years holding's and service's share
decreased significantly while new sectors such as technology and biomed entered the stage.


\subsection{Index inclusion}

```{r}

```



\subsection{Delisting companies}

```{r plot_delisting_comps}

delisted_comps_plot = ggplot(status_df %>% 
                               filter(sector == "Total"),
                             aes(x = year, y = delisted_comps,
                                 label = delisted_comps)) + 
  geom_col(width = 0.7) + 
  geom_text(aes(x = year, y = delisted_comps), vjust = -1,
            color = "magenta", size = 3) + 
  labs(x = "", y = "", title = "Number of delisted companies") + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5), plot.title = element_text(hjust = 0.5))

y_range = ggplot_build(delisted_comps_plot)$layout$panel_params[[1]]$y.range

y_range[2] = 1.02 * y_range[2]

print(delisted_comps_plot + 
        ylim(y_range))

rm(y_range)

```

A total of `r sum(status_df$delisted_comps[status_df$sector == "Total"])` (`r sum(status_df$delisted_comps[status_df$sector == "Total Shares"])` shares and `r sum(status_df$delisted_comps[status_df$sector == "Total Bonds"])` bonds) companies were delisted from TASE during the entire period.

```{r calculate_delisting_cor}

del_cor = status_df %>% 
  filter(sector == "Total") %>% 
  select(year, delisted_comps) %>% 
  mutate(year = as.numeric(year)) %>% 
  inner_join(price_df %>% 
               filter(index_type == "TA125") %>% 
               select(year,avg_close), by = c("year" = "year")) %>% 
  select(-year) %>% 
  cor()

del_cor = del_cor[1,2]


```

We can see that the peak in delisting companies took place in 2012-2014 period, 2018 was also a year with significant delisting activity. The delisting activity seems to take place during market drops (the correlation between TA 125 and delisting companies is `r round(del_cor,2)`)


```{r plot_delisting_comps_by_type}

ggplot(status_df %>% 
         filter(sector %in% c("Total Shares","Total Bonds")),
       aes(x = year,y = delisted_comps, fill = sector)) + 
  geom_col(position = "dodge") + 
  labs(x = "", y = "", title = "Delisted companies by instrument") + 
  theme_bw() + 
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 90, vjust = 0.5))

```


```{r plot_delisting_comps_by_sector}

ggplot(status_df %>% 
         filter(!str_detect(sector,"Total")),
       aes(x = year,y = delisted_comps, fill = sector)) + 
  geom_col(position = "stack") + 
  labs(x = "", y = "", title = "Delisted companies by sector") + 
  scale_fill_brewer(palette = "Set3") +
  theme_bw() + 
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 90, vjust = 0.5))

```



\section{International Comparison}

```{r child="TASE-DescStat-InternationalComparison.Rmd"}

```

